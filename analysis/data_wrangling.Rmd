---
title: "data_wrangling"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)
library(lubridate)
library(maps)
library(datasets)
library(gapminder)
library(viridis)
library(ggnetwork)
library(igraph)
```

## Load In Data

```{r}
# TRADE DATA SET UP ----------------------------------------------------------------------
# For reproducibility, run once the first time you open it, and again only if you delete 
# the files

# trade flow data url
URL <- "http://www.cepii.fr/DATA_DOWNLOAD/baci/trade_flows/BACI_HS17_V202001.zip"

# create a file on the user's desktop 
download.file(url = URL, destfile = "~/Desktop/trade_flows.zip")

# unzip the file 
tradeflows <- unzip("~/Desktop/trade_flows.zip", exdir = "~/Desktop")
```


```{r}
# READ IN DATA ---------------------------------------------------------------------------

#t=Year, k=Product category (HS 6-digit code), i=Exporter (ISO 3-digit country code)
#j=Importer (ISO 3-digit country code), v=Value of the trade flow (in thousands current USD)
#q=Quantity (in metric tons)

# read in trade flow data 
read_csv(tradeflows)

# read in country code data 
countrycodes <- read.csv("../data sets/country_codes.csv")

# read in product code data 
productcodes <- read.csv("../data sets/product_codes.csv")

```

```{r}
# DATA WRANGLING -------------------------------------------------------------------------
```

##Mutating Data
```{r}
#change variable names
tradedata2018_v1 <- tradedata2018 %>%
  select(c(year=t, product=k, Exporter=i, Importer=j, Value=v, Quantity=q))

#export
countrycodes_v1_export <- countrycodes %>%
  select(Exporter = country_code, Exporter_Name = country_name_full)

#fix USA's name for export, likely unefficiently
country_export_noUSA<- countrycodes_v1_export %>%
  filter(Exporter_Name != "USA, Puerto Rico and US Virgin Islands")
country_export_yesUSA<- countrycodes_v1_export %>%
  filter(Exporter_Name == "USA, Puerto Rico and US Virgin Islands")%>%
  mutate(Exporter_Name = "USA")
countrycodes_v1_export <- full_join(country_export_noUSA, country_export_yesUSA)
  

tradedata2018_export <- inner_join(tradedata2018_v1, countrycodes_v1_export, by = "Exporter")

#import
countrycodes_v1_import <- countrycodes %>%
  select(Importer = country_code, Importer_Name = country_name_full)

#fix USA's name for import, likely inefficiently
country_import_noUSA<- countrycodes_v1_import %>%
  filter(Importer_Name != "USA, Puerto Rico and US Virgin Islands")
country_import_yesUSA<- countrycodes_v1_import %>%
  filter(Importer_Name == "USA, Puerto Rico and US Virgin Islands")%>%
  mutate(Importer_Name = "USA")
countrycodes_v1_import <- full_join(country_import_noUSA, country_import_yesUSA)
tradedata2018_import <- inner_join(tradedata2018_v1, countrycodes_v1_import, by = "Importer")


#combine the code so countries by name
tradedata2018_both <- left_join(tradedata2018_export, tradedata2018_import, by = c("year", "product", "Exporter", "Importer", "Value", "Quantity")) %>%
  select(year, product, Exporter_Name, Importer_Name, Value, Quantity) %>%
  mutate(Exporter_Name = as.character(Exporter_Name), Importer_Name = as.character(Importer_Name))

#try to only keep bigger countries because keep getting vector overload
wholevalue <- sum(tradedata2018_both$Value)

#proportion of total value country export, value and prop
exportprop <- tradedata2018_both %>%
  select(year, region = Exporter_Name, Value) %>%
  group_by(year, region) %>%
  summarize(Value = sum(Value)) %>%
  mutate(prop = 100*(Value/wholevalue))

#proportion of total value country import, value and prop
importprop <- tradedata2018_both %>%
  select(year, region = Importer_Name, Value) %>%
  group_by(year, region) %>%
  summarize(Value = sum(Value)) %>%
  mutate(prop = 100*(Value/wholevalue))


```

##Rough Graphs
```{r}

world_map <- map_data(map = "world"
                      , region = ".")
#inner join-ing world map by exported countries
exportgraphdata <- inner_join(world_map, exportprop, by = "region")

#colored graph for exported percentages
ggplot(exportgraphdata, aes(x = long, y = lat, group = group, fill = prop)) +
  geom_polygon(color = "grey") +
  theme_void() +
  coord_fixed(ratio = 1.3) +
  labs(title = "Each country's contribution to total worldwide export in percentages", fill = "Export Percentage", caption = "*Countries in white have no data*") +
  theme(legend.position="bottom") + 
  scale_fill_viridis(option = "viridis", direction = -1) 

#inner joining world map by imported countries
importgraphdata <- inner_join(world_map, importprop, by = "region")

#colored graph for imported percentages
ggplot(importgraphdata, aes(x = long, y = lat, group = group, fill = prop)) +
  geom_polygon(color = "grey") +
  theme_void() +
  coord_fixed(ratio = 1.3) +
  labs(title = "Each country's contribution to total worldwide import in percentages", fill = "Import Percentage", caption = "*Countries in white have no data*") +
  theme(legend.position="bottom") + 
  scale_fill_viridis(option = "plasma", direction = -1) 


#try for arrows, but work on this weekend
#tradedata2018_both_direct <- graph_from_edgelist(as.matrix(tradedata2018_both[,3:4]), directed = TRUE)
#
#ggplot(data = ggnetwork(tradedata2018_both_direct), aes(x = x, y = y, xend = xend, yend = yend)) + geom_edges(arrow=arrow(type="closed", #length=unit(6,"pt"))
#            , color = "lightgray") + geom_nodes() + geom_nodelabel(aes(label = name)) + theme_blank()
```



##Test for other things 
```{r test}
library(scales)
# Export map using value
test <- exportprop 
test$Value <- format(test$Value, scientific = FALSE)
test$Value <- as.numeric(test$Value)
test <- test %>%
  mutate(value_mil = Value/1000)
test$value_mil  <- as.numeric(format(test$value_mil, scientific = FALSE))

testgraphdata <-inner_join(world_map, test, by = "region")

glimpse(test)
# Export map by volume 
ggplot(testgraphdata, aes(x = long, y = lat, group = group, fill = value_mil)) +
  geom_polygon(color = "grey") +
  theme_void() +
  coord_fixed(ratio = 1.3) +
  labs(title = "Export Volume of countries", fill = "Export Volume (in million US$)", caption = "*Countries in white have no data*") +
  theme(legend.position="bottom") + 
  scale_fill_viridis(option = "viridis", direction = -1) 

```

