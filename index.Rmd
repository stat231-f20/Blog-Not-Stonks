---
title: "International Trade"
author: "Leah, Sam, Thai"
date: "11/19/20"
output: 
  rmdformats::material:
    thumbnails: false
    highlight: NULL
---

```{r setup, include=FALSE}
library(tidyverse)
library(evaluate)
library(janitor)
library(lubridate)
library(maps)
library(datasets)
library(gapminder)
library(viridis)
library(ggnetwork)
library(igraph)
library(leaflet)
library(igraph)
library(ggrepel)
library(GGally)
library(visNetwork)
library(rmarkdown)
library(htmltools)

knitr::opts_chunk$set(echo = TRUE, 
                      fig.align="center", 
                      message = FALSE, 
                      warning = FALSE, 
                      comment = NA, 
                      echo = FALSE)
```



```{r}
# TRADE DATA SET UP ----------------------------------------------------------------------
# Run once the first time you open it, and never again unless you delete the files


# trade flow data url
URL <- "http://www.cepii.fr/DATA_DOWNLOAD/baci/trade_flows/BACI_HS17_V202001.zip"

# create a file on the user's desktop 
download.file(url = URL, destfile = "~/Desktop/trade_flows.zip")

```

```{r}
# DATA READ IN ---------------------------------------------------------------------------

# unzip the file and save the .csv to the user's desktop
tradeflows <- unzip("~/Desktop/trade_flows.zip", exdir = "~/Desktop")

# read in trade flow data 
trade_flow <- read_csv(tradeflows)

# read in country code data 
country_codes <- read.csv("data sets/country_codes.csv")

# read in product code data 
product_codes <- read.csv("data sets/product_codes.csv")

```


```{r}
# DATA WRANGLING -------------------------------------------------------------------------

# remove extraneous variables 
countries <- country_codes %>%
  select(country_code, country_name_full) 

# recode levels to match with world map later (not entirely complete, add more if noticed)
countries$country_name_full <- recode(factor(countries$country_name_full), 
                                      "USA, Puerto Rico and US Virgin Islands" = "USA", 
                                      "Plurinational State of Bolivia" = "Bolivia", 
                                      "Russian Federation" = "Russia", 
                                      "France, Monaco" = "France",
                                      "Southern African Customs Union" = "South Africa", 
                                      "Viet Nam" = "Vietnam", 
                                      "United Republic of Tanzania" = "Tanzania", 
                                      "United Kingdom" = "UK", 
                                      "Norway, Svalbard and Jan Mayen" = "Norway")


# master data set with exports and imports (might be useful for networks)
trade_2018 <- trade_flow %>%
         # make variable names descriptive
  rename(year = t, product = k, exporter_code = i, importer_code = j, value = v, 
         quantity = q) %>%
  # year is always 2018 - unnecessary 
  select(-year) %>%
  # add exporter country names 
  left_join(countries, by = c("exporter_code" = "country_code")) %>%
  rename(exporter_name = country_name_full) %>%
  # add importer country names 
  left_join(countries, by = c("importer_code" = "country_code")) %>%
  rename(importer_name = country_name_full)

# separate data set for exports 
trade_exports <- trade_2018 %>%
  select(c(product, value, quantity, exporter_code, exporter_name))

# separate data set for imports 
trade_imports <- trade_2018 %>%
  select(c(product, value, quantity, importer_code, importer_name))

# proportion data sets 
whole_value <- sum(trade_2018$value)

export_prop <- trade_exports %>%
  group_by(exporter_name) %>%
  summarize(export_pct = 100*(sum(value)/whole_value))

import_prop <- trade_imports %>%
  group_by(importer_name) %>%
  summarize(import_pct = 100*(sum(value)/whole_value))
```

```{r}
# MAP SETUP ------------------------------------------------------------------------------

world <- map("world", fill = TRUE, plot = FALSE)

world$names <- str_replace(world$names, pattern = ":.*$", replacement = "")
```

# Introduction
In this project, we will explore international trade relationships. Trade between countries plays a huge role in the development of several sectors of their individual economies, creating millions of jobs worldwide. Through trade countries are able to produce and export goods in which they have the comparative advantage and import goods that other countries have more efficient production in. This leads to accelerated growth for countries economies and finacial markets. In particular, we would like to visualize these relationships, and identify natural groupings among countries, as well as figure out how much trade is involved within different country groups.

In order to do so, we obtained worldwide trade flows data in 2017 from CEPII, which incorporates yearly bilateral trades down to the product level. This data is directly taken from reports submitted to the United Nationals Statiscial Division. The data set includes variables such as year, product category (HS code), exporter, importer, value of the trade (in $1,000), and lastly quantity (in metric tons). Through grouping by exporter and importer and summing the value of trade, we arrive at the final dataset with trade volumes (in terms of value) between different countries in the world. We further calculate the percentage of contribution of a country's export and import to the total world trade and arrive at the next visualization. We chose to work in terms of trade volumes (in US $1,000) as this would weigh not only absolute volume of goods traded, but absolute volume weighted by its value so there is an even playing field.

# Overview
To understand the interworkings of international trade, we create a spatial data graph of the World and a trade network of clusters. This spatial graph is colored by export and import percentage. We were intrested to see the relationship between exporting and importing percentages. The clusters were chosen through unsuprived learning by volume (in terms of value) of trade. The first network graph is the network of the high volume (in terms of value) trade, where the thickness of arrows represent the amount in terms of value traded. The second network graph shows the trade between the medium trade volume countries. 


# World Exports and Imports {.tabset .tabset-fade .tabset-pills}

## Contribution to World Exports by Country

```{r exports}
# EXPORT MAP -----------------------------------------------------------------------------

# set up export data 
export_pct_named <- export_prop$export_pct
names(export_pct_named) <- export_prop$exporter_name

world$export_pct <- export_pct_named[world$names]

# define a color palette
mypalette <- colorNumeric(palette = "viridis", domain = world$export_pct, 
                           na.color = "transparent")

# interactive map 
leaflet(world) %>%
  addTiles() %>%
  setView(lat=10, lng=0 , zoom=2) %>%
  # overlay export information
  addPolygons(color = "white", fillColor = ~mypalette(export_pct), weight = 1) %>%
  addLegend(pal = mypalette, values = ~export_pct, 
            title = "Export Percent", position = "bottomleft")

#tried to add this for the hover function
#%>%
    #addMarkers(~long, ~lat, label = ~export_prop(exporter_name))


```

In this map, we are visualizing contributions of each country to total world export value. There are two clear observations: three countries (Germany, US and China) contributed significantly to world export, with each one contributing more than 8% of total world export; and the rest of the countries individually contribute very little to world export, mostly less than 2%.

## Contribution to World Imports by Country 

```{r imports}
# IMPORT MAP -----------------------------------------------------------------------------

# set up import data 
import_pct_named <- import_prop$import_pct
names(import_pct_named) <- import_prop$importer_name

world$import_pct <- import_pct_named[world$names]

# interactive map
leaflet(world) %>%
  addTiles() %>%
  setView(lat=10, lng=0 , zoom=2) %>%
  # overlay import information
  addPolygons(color = "white", fillColor = ~mypalette(import_pct), weight = 1) %>%
  addLegend(pal = mypalette, values = ~import_pct, 
            title = "Import Percent", position = "bottomleft")
```

In this map, we are visualizing contributions of each country to total world import value. We once again see Germany, US and China contributing significantly to world import, with each one contributing more than 8% of total world export. However, China, which is the leading exporter in 2017, is not the leading importer, but it is actually the US. This might indicate an interesting relationship between these two countries, which we intend to further explore through network science. 

# Trade Networks {.tabset .tabset-fade .tabset-pills}

```{r unsup}
# CLUSTERING SETUP -----------------------------------------------------------------------

# combine export and import data for clustering
trade_combine <- export_prop %>%
  inner_join(import_prop, by = c("exporter_name" = "importer_name")) %>%
  rename(country = exporter_name)

vars <- c("export_pct" , "import_pct")

# WSS plot for optimal number of clusters
wss_plot <- trade_combine %>%
  select(c(export_pct, import_pct)) %>%
  factoextra::fviz_nbclust(kmeans, method = "wss")

# Use k-means clustering to identify 3 clusters based on contribution in terms of export 
# and import to world trade

# K-MEANS CLUSTERING ---------------------------------------------------------------------

# set seed for reproducibility
set.seed(100)

km_trade <- trade_combine %>%
  select(c(export_pct, import_pct)) %>%
  kmeans(centers=3, nstart=20)

trade_combine_clust3 <- trade_combine %>%
  mutate(clust3 = as.character(km_trade$cluster))

# to help us identify how clusters are divided
# km_trade$centers
```

```{r networkSetup}
# NETWORK SETUP --------------------------------------------------------------------------

# get trade between countries 
trade_network <- trade_2018 %>%
  select(value, exporter_name, importer_name) %>%
  group_by(exporter_name, importer_name) %>%
  summarize(total_trade = sum(value)) 

# join trade and cluster information
trade_network_clust <- trade_network %>%
  left_join(trade_combine_clust3, by = c("exporter_name" = "country")) %>%
  rename(clust_ex = clust3) %>%
  select(exporter_name, importer_name, total_trade, clust_ex) %>%
  left_join(trade_combine_clust3, by = c("importer_name" = "country")) %>%
  rename(clust_im = clust3) %>%
  select(exporter_name, importer_name, total_trade, clust_ex, clust_im) 

# cluster one is too intricate to visualize

# subset of countries in cluster two 
clust_2_network <- trade_network_clust %>%
  filter(clust_ex == 2) %>%
  filter(clust_im == 2)

# subset of countries in cluster three
clust_3_network <- trade_network_clust %>%
  filter(clust_ex == 3) %>%
  filter(clust_im == 3)

# function for an interactive network 
make_network <- function(network) {
  
  # ensure that concatenating returns a factor
  c.factor <- function(..., recursive=TRUE) unlist(list(...), recursive=recursive)
  
  # identify all unique countries in the data (either exporting or importing)
  name_vec <- name_vec <- c.factor(unique(c.factor(unique(network$exporter_name), 
                     unique(network$importer_name))))
  
  # information required for visNetwork
  from <- network$exporter_name
  to <- network$importer_name
  trade <- network$total_trade
  
  # create edges                            # thickness determined by trade volume
  edges <- data.frame(from = from, to = to, value = trade)
  
  # create nodes
  nodes <- data.frame(id = name_vec, label = name_vec, group = name_vec)

  # network visualizations
  visNetwork(nodes, edges, height = "500px", width = "100%")  %>% 
    visNodes(shape = "dot") %>%  
             # arrows show exports
    visEdges(arrows = "to", arrowStrikethrough = F, smooth = T, physics = F) %>%
    # hide other nodes and incoming edges when a node is selected
    visOptions(highlightNearest = list(enabled = T, degree = 0)) %>%
    # add navigation buttons and allow multiple nodes to be selected at once
    visInteraction(navigationButtons = TRUE, multiselect = TRUE) %>%
  visLayout(randomSeed = 17)

}
```

## High Trade Volume Countries

```{r interactive clustered 2 networks}
# cluster two network 
make_network(clust_2_network) 
```
- click on a country to highligh its network


## Medium Trade Volume Countries

```{r interactive clustered 3 networks}
# cluster three network 
make_network(clust_3_network)
```
- click on a country to highligh its network


