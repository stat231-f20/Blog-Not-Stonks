---
title: "International Trade"
author: "Leah, Sam, Thai"
date: "11/19/20"
output: 
  rmdformats::readthedown:
    thumbnails: false
    highlight: NULL
---

```{r setup, include=FALSE}
library(tidyverse)
library(evaluate)
library(janitor)
library(lubridate)
library(maps)
library(datasets)
library(gapminder)
library(viridis)
library(ggnetwork)
library(igraph)
library(leaflet)
library(igraph)
library(ggrepel)
library(GGally)
library(visNetwork)
library(rmarkdown)
library(htmltools)

knitr::opts_chunk$set(echo = TRUE, 
                      fig.align="center", 
                      message = FALSE, 
                      warning = FALSE, 
                      comment = NA, 
                      echo = FALSE)

theme_set(theme_minimal())
```



```{r, eval = F}
# TRADE DATA SET UP ----------------------------------------------------------------------
# Run once the first time you open it, and never again unless you delete the files


# trade flow data url
URL <- "http://www.cepii.fr/DATA_DOWNLOAD/baci/trade_flows/BACI_HS17_V202001.zip"

# create a file on the user's desktop 
download.file(url = URL, destfile = "~/Desktop/trade_flows.zip")

```

```{r}
# DATA READ IN ---------------------------------------------------------------------------

# unzip the file and save the .csv to the user's desktop
tradeflows <- unzip("~/Desktop/trade_flows.zip", exdir = "~/Desktop")

# read in trade flow data 
trade_flow <- read_csv(tradeflows)

# read in country code data 
country_codes <- read.csv("data sets/country_codes.csv")

# read in product code data 
product_codes <- read.csv("data sets/product_codes.csv")

```


```{r}
# DATA WRANGLING -------------------------------------------------------------------------

# remove extraneous variables 
countries <- country_codes %>%
  select(country_code, country_name_full) 

# recode levels to match with world map later (not entirely complete, add more if noticed)
countries$country_name_full <- recode(factor(countries$country_name_full), 
                                      "USA, Puerto Rico and US Virgin Islands" = "USA", 
                                      "Plurinational State of Bolivia" = "Bolivia", 
                                      "Russian Federation" = "Russia", 
                                      "France, Monaco" = "France",
                                      "Southern African Customs Union" = "South Africa", 
                                      "Viet Nam" = "Vietnam", 
                                      "United Republic of Tanzania" = "Tanzania", 
                                      "United Kingdom" = "UK", 
                                      "Norway, Svalbard and Jan Mayen" = "Norway")


# master data set with exports and imports (might be useful for networks)
trade_2018 <- trade_flow %>%
         # make variable names descriptive
  rename(year = t, product = k, exporter_code = i, importer_code = j, value = v, 
         quantity = q) %>%
  # year is always 2018 - unnecessary 
  select(-year) %>%
  # add exporter country names 
  left_join(countries, by = c("exporter_code" = "country_code")) %>%
  rename(exporter_name = country_name_full) %>%
  # add importer country names 
  left_join(countries, by = c("importer_code" = "country_code")) %>%
  rename(importer_name = country_name_full)

# separate data set for exports 
trade_exports <- trade_2018 %>%
  select(c(product, value, quantity, exporter_code, exporter_name))

# separate data set for imports 
trade_imports <- trade_2018 %>%
  select(c(product, value, quantity, importer_code, importer_name))

# proportion data sets 
whole_value <- sum(trade_2018$value)

export_prop <- trade_exports %>%
  group_by(exporter_name) %>%
  summarize(export_pct = 100*(sum(value)/whole_value))

import_prop <- trade_imports %>%
  group_by(importer_name) %>%
  summarize(import_pct = 100*(sum(value)/whole_value))
```

```{r}
# MAP SETUP ------------------------------------------------------------------------------

world <- map("world", fill = TRUE, plot = FALSE)

world$names <- str_replace(world$names, pattern = ":.*$", replacement = "")
```

# Introduction

Trade has been a quintessential component of human interaction since the dawn of history. In its simplest fashion we had the barter system -- the exchange of goods and services without the use of money. As society developed further, and we began to explore the concept of a 'nation' as a unit above the individual, the scope of trade found natural extensions to the international sphere. 

In its early years, trade was thought of as quite competitive, and nations believed that if one were to increase their trade, this could only be done at the cost of another. Countries actively tried to dominate in terms of exports, but minimized imports, believing this would best protect their interests. This viewpoint was overturned with the advent of liberalism, and the idea that trade should be free. As a whole, we've gone back and forth between these ideas over the years, and landed somewhere in the middle -- free trade as far as possible, with trade agreements and global organizations to keep us all in line. 

Now, international trade is an integral part of the global economy. Countries enter into economic transactions with one another whereby they are able to produce and export goods in which they have the comparative advantage and import goods that other countries have more efficient production in. Through trading, countries are able to take advantage of their different specialties, which leads to accelerated growth for their individual economies and financial markets. A long way from the barter system of old, international trade today is facilitated by large financial institutions, and in 2018 alone the total value of global exports was approximately 19.5 trillion USD. 

# Our Analysis

In the United States, there's a widespread view that China is the major exporter, and the US the major importer in the global economy. But how much does China dominate the export market, and is the United States as big of a player in the import market as we think? In addition, are there natural divisions among countries in terms of trade volumes? What does the global trade network really look like? These are the questions we look to address. 

These questions all relate in some way to the distribution of trade worldwide. To get a broad overview, we look first at choropleths depicting share in total exports, and in total imports, by country. This gives us a preliminary understanding, not only of how countries relate to one another in terms of exports and imports, but also of how imports and exports relate within a particular country. We then move to the second question -- do natural groupings arise among countries based on trade volume? To explore this, we conduct a cluster analysis using k-means, which in turn forms the basis of a network analysis, where we look at how countries in these clusters interact, and which appear to be the most important.

# Data Background

The visualizations and analysis that follow are based on worldwide trade flow data taken from [CEPII](http://www.cepii.fr/CEPII/en/bdd_modele/presentation.asp?id=37), which incorporates yearly bilateral trades down to the product level. This data is directly taken from reports submitted to the United Nations Statistical Division, and includes variables such as year, product category, exporter, importer, value of the trade (in \$1,000), and lastly quantity (in metric tons). 

We restrict our focus particularly to the year 2017. Through grouping by exporter and importer and summing the value of trade, we are able to calculate trade volumes (in terms of value, for better comparison) between various different countries. We further use this to calculate a country's share in total exports and imports. 

# World Exports and Imports {.tabset .tabset-fade .tabset-pills}

## Contribution to World Exports by Country

```{r exports}
# EXPORT MAP -----------------------------------------------------------------------------

# set up export data 
export_pct_named <- export_prop$export_pct
names(export_pct_named) <- export_prop$exporter_name

world$export_pct <- export_pct_named[world$names]

# define a color palette
mypalette <- colorNumeric(palette = "viridis", domain = world$export_pct, 
                           na.color = "transparent")

# interactive map 
leaflet(world) %>%
  addTiles() %>%
  setView(lat=10, lng=0 , zoom=2) %>%
  # overlay export information
  addPolygons(color = "white", fillColor = ~mypalette(export_pct), weight = 1) %>%
  addLegend(pal = mypalette, values = ~export_pct, 
            title = "Export Percent", position = "bottomleft")

#tried to add this for the hover function
#leaflet() %>% addTiles() %>%
#  addPopups(-122.327298, 47.597131, content,
#    options = popupOptions(closeButton = FALSE)  )
#try by using import_data from data wrangling last r chunk


```

The map above displays individual country contributions, as a percentage of total world export value. Countries in gray correspond to those for which we did not have data. As expected, China appears to dominate exports, accounting for around 14\% of total world exports. The United States and Germany also contribute significantly, with each contributing more than 8\% of total world exports. However the rest of the countries seem to contribute very little individually, with most accounting for less than 2\% of global exports each. 

## Contribution to World Imports by Country 

```{r imports}
# IMPORT MAP -----------------------------------------------------------------------------

# set up import data 
import_pct_named <- import_prop$import_pct
names(import_pct_named) <- import_prop$importer_name

world$import_pct <- import_pct_named[world$names]

# interactive map
leaflet(world) %>%
  addTiles() %>%
  setView(lat=10, lng=0 , zoom=2) %>%
  # overlay import information
  addPolygons(color = "white", fillColor = ~mypalette(import_pct), weight = 1) %>%
  addLegend(pal = mypalette, values = ~import_pct, 
            title = "Import Percent", position = "bottomleft")
```

Here we look at the contributions of each country to total world imports, as a percentage. Once again, countries in gray correspond to those for which data were unavailable. We see that Germany, the United States, and China appear to be the major players. Interestingly, though China is the leading exporter in 2017, it is the United States that dominates with respect to imports, accounting for around 12\% of the global total. This might indicate an interesting relationship between these two countries, which we will explore in the clustering and network analyses. 

# Clustering {.tabset .tabset-fade .tabset-pills}

From our initial visualizations, it seems at least that the United States, Germany, and China, are distinct in terms of exports and imports. In order to uncover any other natural groups, as well as to see if these three countries do indeed form a group, we undertake a cluster analysis using k-means -- a partitioning method. 

## Testing the Optimal Number of Clusters

Since the k-means solution requires us to specify a number of clusters, we look at the total within group sum of squares as a metric by which to select the optimal number of clusters. Below, we plot the total within group sum of squares vs. the optimal number of clusters, looking for an "elbow" in the plot.

```{r unsup 1}
# CLUSTERING SETUP -----------------------------------------------------------------------

# combine export and import data for clustering
trade_combine <- export_prop %>%
  inner_join(import_prop, by = c("exporter_name" = "importer_name")) %>%
  rename(country = exporter_name)

vars <- c("export_pct" , "import_pct")

# Testing optimal number of clusters
fig <- matrix(NA, nrow=10, ncol=2)
set.seed(75)
for (i in 1:10){
  fig[i,1] <- i
  fig[i,2] <- kmeans(trade_combine[,2:3]
                    , centers=i
                    , nstart=20)$tot.withinss
}

ggplot(data = as.data.frame(fig), aes(x = V1, y = V2)) +
  geom_point() +
  geom_line() +
  scale_x_continuous(breaks=c(1:10)) +
  labs(title = "Within Group Sum of Squares vs. Number of Clusters",
       x = "Number of Clusters (k)", 
       y = expression("Total W"[k]))
```

From this graph of within group sum of squares against the number of clusters, we can see that there is a clear "elbow" at 3 clusters, which indicates that the optimal number of clusters for our k-means solution is 3. Beyond this, an increase in number of clusters doesn't provide us much improvement in the solution, and so would be an unnecessary increase in complexity.  

## Visualizing the Cluster Solution

```{r unsup 2}
# K-MEANS CLUSTERING ---------------------------------------------------------------------

# set seed for reproducibility
set.seed(100)

km_trade <- trade_combine %>%
  select(c(export_pct, import_pct)) %>%
  kmeans(centers=3, nstart=20)

trade_combine_clust3 <- trade_combine %>%
  mutate(clust3 = as.character(km_trade$cluster))

# visualize the cluster assignments and centroids
ggplot(data = trade_combine_clust3, aes(x = import_pct, y = export_pct)) + 
  geom_point(aes(color = clust3)) +
  coord_fixed() +
  geom_point(data = as.data.frame(km_trade$centers), aes(x = import_pct, y = export_pct),
             pch = "X", size = 4) +
  labs(title = "Three Cluster Solution",
       x = "Percentage of Total Imports", 
       y = "Percentage of Total Exports", 
       color = "Cluster Assignment:") + 
  theme(legend.position = "bottom")
```

From the graph above, we can see the large disparity between clusters, particularly with respect to the countries in cluster 2. These three countries contributed significantly more to world exports and imports than the rest of the other countries as they, on average, contribute 10% to world trade individually. 

In cluster 3, the countries, on average, contribute close to 2.5% of total world trade, much lower than in cluster 2 but also much higher than cluster 1 which contains most of the countries in the world but each contributed negligibly in comparison to world trade. 

# Trade Networks {.tabset .tabset-fade .tabset-pills}

From our cluster analysis, we were able to identify 3 groups of countries, corresponding to low, medium, and high volumes of trade. Of these, we want to look at relationships within the medium and high trade volume countries in particular, since there are far too many low trade volume countries to be able to get a meaningful visualization.

The networks below display the relationships among high trade volume countries. Arrows indicate the direction of exports, and as such point from the exporting country to the importing country. Edges in this graph are colored corresponding to their country of origin or exporter country, and sized based on the volume of trade, with larger edges indicating more volume.

You can interact with the nodes by dragging and moving them, or using the navigation buttons. Further, you can highlight a particular country's exports by clicking on its corresponding nodes. You can select multiple countries, by clicking and holding their corresponding nodes.   

```{r networkSetup}
# NETWORK SETUP --------------------------------------------------------------------------

# get trade between countries 
trade_network <- trade_2018 %>%
  select(value, exporter_name, importer_name) %>%
  group_by(exporter_name, importer_name) %>%
  summarize(total_trade = sum(value)) 

# join trade and cluster information
trade_network_clust <- trade_network %>%
  left_join(trade_combine_clust3, by = c("exporter_name" = "country")) %>%
  rename(clust_ex = clust3) %>%
  select(exporter_name, importer_name, total_trade, clust_ex) %>%
  left_join(trade_combine_clust3, by = c("importer_name" = "country")) %>%
  rename(clust_im = clust3) %>%
  select(exporter_name, importer_name, total_trade, clust_ex, clust_im) 

# cluster one is too intricate to visualize

# subset of countries in cluster two 
clust_2_network <- trade_network_clust %>%
  filter(clust_ex == 2) %>%
  filter(clust_im == 2)

# subset of countries in cluster three
clust_3_network <- trade_network_clust %>%
  filter(clust_ex == 3) %>%
  filter(clust_im == 3)

# function for an interactive network 
make_network <- function(network) {
  
  # ensure that concatenating returns a factor
  c.factor <- function(..., recursive=TRUE) unlist(list(...), recursive=recursive)
  
  # identify all unique countries in the data (either exporting or importing)
  name_vec <- name_vec <- c.factor(unique(c.factor(unique(network$exporter_name), 
                     unique(network$importer_name))))
  
  # information required for visNetwork
  from <- network$exporter_name
  to <- network$importer_name
  trade <- network$total_trade
  
  # create edges                            # thickness determined by trade volume
  edges <- data.frame(from = from, to = to, value = trade)
  
  # create nodes
  nodes <- data.frame(id = name_vec, label = name_vec, group = name_vec)

  # network visualizations
  visNetwork(nodes, edges, height = "500px", width = "100%")  %>% 
    visNodes(shape = "dot") %>%  
             # arrows show exports
    visEdges(arrows = "to", arrowStrikethrough = F, smooth = T, physics = F) %>%
    # hide other nodes and incoming edges when a node is selected
    visOptions(highlightNearest = list(enabled = T, degree = 0)) %>%
    # add navigation buttons and allow multiple nodes to be selected at once
    visInteraction(navigationButtons = TRUE, multiselect = TRUE) %>%
  visLayout(randomSeed = 17)

}
```

## High Trade Volume Countries


```{r interactive clustered 2 networks}
# cluster two network 
make_network(clust_2_network) 
```

In the network above, which displays the relationship between high trade volume countries, we can see in particular that there is a large volume of trade flow from China to the United States. While we might previously have expected this given that China is the largest exporter, and the United States the largest importer, we did not know until now whether that was due to a direct relationship between the two. 

## Medium Trade Volume Countries


```{r interactive clustered 3 networks}
# cluster three network 
make_network(clust_3_network)
```

This network looks slightly hard to read at first, but becomes clearer when you take advantage of the interactive elements. Highlighting the Netherlands, we can see that there seems to be a large volume of trade flow from the Netherlands to Belgium and Luxembourg, and the United Kingdom. Highlighting Belgium shows that they appear to export a lot to France as well, and this relationship is reciprocal. France also appears to have noticeable exports to the United Kingdom. So all of these countries appear to be closely related.

We can continue to extract insight from this network -- Korea, for example, seems to have strong export relations with several regions including Japan, Hong Kong, and Vietnam, and there is a strong bilateral relationship between Singapore and Malaysia. 

# Conclusion 



# Citations 

https://www.statista.com/statistics/264682/worldwide-export-volume-in-the-trade-since-1950/

https://www.britannica.com/topic/international-trade

http://www.cepii.fr/CEPII/en/bdd_modele/presentation.asp?id=37
